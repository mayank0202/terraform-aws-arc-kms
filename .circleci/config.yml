version: 2
jobs:
  plan:
    docker:
      - image: hashicorp/terraform:latest
    working_directory: /example
    steps:
      - checkout
      - run:
          name: Init
          command: terraform init -input=false
      - run:
          name: Plan
          command: terraform plan -input=false -out=tfplan -no-color
      - run:
          name: Render plan for PR comment
          command: terraform show -no-color tfplan > tfplan.txt
      - persist_to_workspace:
          root: /example
          paths:
            - ./example

  apply:
    docker:
      - image: hashicorp/terraform:latest
    working_directory: /example
    steps:
      - attach_workspace:
          at: /code
      - run:
          name: Apply
          command: terraform apply

workflows:
  version: 2
  plan_pr:
    jobs:
      - plan
      - plan_comment:
          requires:
            - plan
          filters:
            branches:
              ignore: main
      - hold-apply:
          type: approval
          requires:
            - plan        
      - apply:
          requires:
            - hold-apply
          filters:
            branches:
              only: main
